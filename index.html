<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>６ちゃんねる</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    .thread { padding: 10px; background: #fff; margin: 10px 0; border: 1px solid #ccc; }
    #board-tabs button { margin: 0 5px; }
    #user-area { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>６ちゃんねる</h1>
  <div id="user-area">
    <span id="login-status">未ログイン</span>
    <input type="password" id="user-password" placeholder="パスワード" />
    <button id="user-login-btn">ログイン</button>
    <button id="user-logout-btn" style="display:none;">ログアウト</button>
  </div>
  <div id="board-tabs">読み込み中...</div>
  <div id="threads"></div>

  <h2>スレッド作成</h2>
  <form id="thread-form">
    <input type="text" id="title" placeholder="タイトル" required /><br />
    <textarea id="body" placeholder="本文" required></textarea><br />
    <input type="text" id="name" placeholder="名前（省略可）" /><br />
    <input type="password" id="password" placeholder="削除用パスワード" required /><br />
    <button type="submit">作成</button>
  </form>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://vpvvdkbkghyfiflkidno.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwdnZka2JrZ2h5ZmlmbGtpZG5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1ODExNTcsImV4cCI6MjA2NzE1NzE1N30.bGHEpq0Z9XCSY8SJE7-aGQpLA4axBDH4J4hCxyakbLg"
    );

    let currentBoard = null;

    // ログイン状態更新
    function updateLoginStatus() {
      const isAdmin = localStorage.getItem("isAdmin") === "true";
      const isUser = localStorage.getItem("isUser") === "true";
      const loginStatus = document.getElementById("login-status");
      if (isAdmin) loginStatus.textContent = "管理者ログイン中";
      else if (isUser) loginStatus.textContent = "ログイン中";
      else loginStatus.textContent = "未ログイン";

      document.getElementById("user-login-btn").style.display = isAdmin || isUser ? "none" : "inline-block";
      document.getElementById("user-password").style.display = isAdmin || isUser ? "none" : "inline-block";
      document.getElementById("user-logout-btn").style.display = isAdmin || isUser ? "inline-block" : "none";
    }

    // ログイン処理
    document.getElementById("user-login-btn").onclick = () => {
      const pw = document.getElementById("user-password").value;
      if (pw === "wakakusanagisa") {
        localStorage.setItem("isAdmin", "true");
        alert("管理者としてログインしました");
      } else if (pw === "wakakusa") {
        localStorage.setItem("isUser", "true");
        alert("通常ユーザーとしてログインしました");
      } else {
        alert("パスワードが間違っています");
        return;
      }
      updateLoginStatus();
    };

    // ログアウト処理
    document.getElementById("user-logout-btn").onclick = () => {
      localStorage.removeItem("isAdmin");
      localStorage.removeItem("isUser");
      alert("ログアウトしました");
      updateLoginStatus();
    };

    // 板一覧取得と表示
    async function loadBoards() {
      const tabEl = document.getElementById("board-tabs");
      const { data, error } = await supabase.from("boards").select("*");
      if (error || !data) {
        tabEl.textContent = "板情報の読み込み失敗";
        return;
      }
      tabEl.innerHTML = '';

      if (data.length === 0) {
        tabEl.textContent = "板が存在しません";
        document.getElementById("threads").textContent = "";
        return;
      }

      data.forEach(board => {
        const btn = document.createElement("button");
        btn.textContent = board.name;
        btn.onclick = () => {
          currentBoard = board.slug;
          loadThreads();
          updateActiveBoardButton();
        };
        tabEl.appendChild(btn);
      });

      // 最初の板を自動選択してスレッド読み込み
      currentBoard = data[0].slug;
      loadThreads();
      updateActiveBoardButton();
    }

    // 選択中の板ボタンをハイライト
    function updateActiveBoardButton() {
      const buttons = document.querySelectorAll("#board-tabs button");
      buttons.forEach(btn => {
        if (btn.textContent === currentBoard) {
          btn.style.backgroundColor = "#ddd";
        } else {
          btn.style.backgroundColor = "";
        }
      });
    }

    // スレッド一覧と最新コメントを読み込み表示
    async function loadThreads() {
      const { data: threads, error } = await supabase
        .from("threads")
        .select("*")
        .eq("board_slug", currentBoard)
        .order("created_at", { ascending: false });

      const container = document.getElementById("threads");
      container.innerHTML = "";

      if (error) {
        container.textContent = "スレッドの読み込みに失敗しました";
        console.error(error);
        return;
      }

      if (!threads || threads.length === 0) {
        container.textContent = "スレッドがありません";
        return;
      }

      for (const thread of threads) {
        // 最新コメント取得
        const { data: comments, error: cError } = await supabase
          .from("comments")
          .select("*")
          .eq("thread_id", thread.id)
          .order("created_at", { ascending: false })
          .limit(1);

        let latestCommentText = "";
        if (!cError && comments && comments.length > 0) {
          latestCommentText = comments[0].body;
        }

        const div = document.createElement("div");
        div.className = "thread";
        div.innerHTML = `
          <a href="thread.html?id=${thread.id}">${thread.title}</a><br>
          ${thread.body}<br>
          <small>最新コメント: ${latestCommentText || "なし"}</small>
        `;
        container.appendChild(div);
      }
    }

    // スレッド作成フォーム送信処理
    document.getElementById("thread-form").addEventListener("submit", async (e) => {
      if (!(localStorage.getItem("isUser") === "true" || localStorage.getItem("isAdmin") === "true")) {
        alert("ログインが必要です。先にログインしてください。");
        return;
      }
      e.preventDefault();
      const title = document.getElementById("title").value;
      const body = document.getElementById("body").value;
      const name = document.getElementById("name").value || "名無しさん";
      const password = document.getElementById("password").value;
      if (!currentBoard) return alert("板を選択してください");

      const { error } = await supabase.from("threads").insert({
        board_slug: currentBoard,
        title, body, name, password
      });
      if (error) return alert("スレッド作成に失敗しました");
      e.target.reset();
      loadThreads();
    });

    // コメント追加のリアルタイム監視
    function subscribeComments() {
      supabase
        .channel('public:comments')
        .on(
          'postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'comments' },
          () => {
            // 新しいコメントが追加されたらスレッド一覧を再読み込み
            loadThreads();
          }
        )
        .subscribe();
    }

    // 初期処理
    loadBoards();
    updateLoginStatus();
    subscribeComments();

  </script>
</body>
</html>
